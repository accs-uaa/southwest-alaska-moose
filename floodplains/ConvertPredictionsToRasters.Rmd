---
title: "Convert Predictions to Rasters"
author: "Timm Nawrocki"
date: "April 21, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r header}
# -*- coding: utf-8 -*-
# ---------------------------------------------------------------------------
# Convert Predictions to Rasters
# Author: Timm Nawrocki, Alaska Center for Conservation Science
# Created on: 2019-04-21
# Usage: Code chunks must be executed sequentially in R Studio or R Studio Server installation. Created using R Studio version 1.2.1335 and R 3.5.3.
# Description: "Convert Predictions to Raster" processes the floodplain predictions in csv tables into rasters in img format. Raster outputs are in the same coordinate system that watersheds were exported in but will not be associated with that projection.
# ---------------------------------------------------------------------------
```

## 1. Introduction

This script converts predictions by subwatershed from a regular grid point matrix to a raster at matching resolution, grid, and projection. The coordinate system of the output rasters is undefined. The watershed rasters are not merged by this script but can be merged with the "Mosaic to New Raster" tool in ArcGIS Pro or using the Rasterio python library.

## 2. Import data and variables

Conversion of predictions in regular grid point matrix stored as csv to rasters requires the sp, raster, rgdal, and stringr libraries.

```{r inputs}
# Set root directory
drive = 'E:/'
root_directory = paste(drive, '/ACCS_Work/Projects/VegetationEcology/BristolBay_Vegetation/Project_GIS/Data_Output/model_floodplain', sep='')
# Define input folder
prediction_folder = paste(root_directory, '/output_tables', sep='')
# Define output folder
raster_folder = paste(root_directory, '/output_rasters', sep='')
```

```{r libraries}
# Install required libraries if they are not already installed.
Required_Packages <- c('sp', 'raster', 'rgdal', 'stringr')
New_Packages <- Required_Packages[!(Required_Packages %in% installed.packages()[,"Package"])]
if (length(New_Packages) > 0) {
  install.packages(New_Packages)
}
# Import required libraries for geospatial processing: sp, raster, rgdal, and stringr.
library(sp)
library(raster)
library(rgdal)
library(stringr)
```

```{r input_files}
# Generate a list of all predictions in the predictions directory
prediction_list = list.files(prediction_folder, pattern='csv$', full.names=TRUE)
prediction_length = length(prediction_list)
```

## 3. Define Functions

```{r functions}
# Define a function to convert the prediction csv to a raster and export an img raster file
convertPredictions = function(input_data, output_raster) {
  prediction_data = input_data[,c('POINT_X', 'POINT_Y', 'presence')]
  prediction_raster = rasterFromXYZ(prediction_data, res=c(10,10), crs=NA, digits=5)
  writeRaster(prediction_raster, output_raster, format='HFA', overwrite=TRUE)
}
```

## 4. Conduct conversions

```{r conversions}
# Create img raster file for each prediction table in the predictions directory
count = 1
for (prediction in prediction_list) {
  input_data = read.csv(prediction)
  output_raster = paste(raster_folder, '/', sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(prediction)), '.img', sep='')
  convertPredictions(input_data, output_raster)
  print(paste('Conversion iteration ', toString(count), ' out of ', toString(prediction_length), ' completed...', sep=''))
  count = count + 1
}
```